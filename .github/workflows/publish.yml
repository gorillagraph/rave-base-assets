name: Publish

on:
  push:
    # Triggers the workflow on push events for the branches prefixed with "release-",
    # where the rest of the branch name typically represents the environment namespace.
    branches:
      - release-*

  # Allows running this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to publish to
        type: environment
        required: true

jobs:
  set_environment:
    name: Set Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.setenv.outputs.environment }}
    steps:
      - name: Determine Environment
        id: setenv
        run: |
          if [ -n "${{ inputs.environment }}" ]; then
            environment="${{ inputs.environment }}"
          else
            environment="${GITHUB_REF_NAME#release-}"
          fi
          echo "environment=$environment" >> "$GITHUB_OUTPUT"

  publish:
    name: Publish
    needs: set_environment
    runs-on: ubuntu-latest
    environment: ${{ needs.set_environment.outputs.environment }}

    permissions:
      contents: read
      id-token: write
      issues: write

    steps:
      - name: Check Configuration
        id: decode-token
        run: |
          set -euo pipefail
          if [ -n "${{ secrets.AUTH_TOKEN }}" ]; then
            AUTH_TOKEN="${{ secrets.AUTH_TOKEN }}"
          else
            AUTH_TOKEN="${{ vars.AUTH_TOKEN }}"
          fi
          if [ -z "$AUTH_TOKEN" ]; then
            echo "AUTH_TOKEN is not set." >&2
            exit 1
          fi
          DECODED_STRING="$(printf '%s' "$AUTH_TOKEN" | base64 --decode)"
          IFS='|' read -ra PARTS <<< "$DECODED_STRING"
          if [ -z "${PARTS[0]:-}" ] || [ -z "${PARTS[1]:-}" ]; then
            echo "AUTH_TOKEN is malformed." >&2
            exit 1
          fi
          echo "host=${PARTS[0]}" >> "$GITHUB_OUTPUT"
          echo "api_key=${PARTS[1]}" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v5

      - name: Process templates folder
        id: process-data
        run: zip -r ../templates.zip .
        working-directory: ${{ github.workspace }}/templates

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Validate templates
        id: validate
        run: |
          echo "::add-mask::${{ steps.decode-token.outputs.api_key }}"
          scripts/publish_templates.py validate \
            --host "${{ steps.decode-token.outputs.host }}" \
            --api-key "${{ steps.decode-token.outputs.api_key }}" \
            --zip-path templates.zip

      - uses: trstringer/manual-approval@v1
        if: ${{ steps.validate.outputs.has_ignored == 'true' }}
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ github.actor }}
          minimum-approvals: 1
          issue-title: "Action Required for Specific Files"
          issue-body: |
            Certain files cannot be processed and will be excluded from the deployment:
            ${{ steps.validate.outputs.ignored_msg }}

            Approve to proceed excluding these files. Cancel if you want to adjust files and rerun.

      - name: Push templates
        run: |
          scripts/publish_templates.py push \
            --host "${{ steps.decode-token.outputs.host }}" \
            --api-key "${{ steps.decode-token.outputs.api_key }}" \
            --zip-path templates.zip
